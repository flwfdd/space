---
import Layout from "./Layout.astro";
import NotesIndex from "@/components/notes/NotesIndex.astro";
import TableOfContents from "@/components/notes/TableOfContents.astro";
import { Icon } from "astro-icon/components";

const {
  title = "笔记 - flwfdd's space",
  description = "数字花园",
  headings = [],
  showSidebar = true,
  showToc = true,
  currentPath,
} = Astro.props;
---

<Layout title={title} description={description}>
  <div class="flex max-w-screen-xl mx-auto">
    <!-- 桌面端目录 -->
    {
      showSidebar && (
        <div class="hidden lg:block flex-shrink-0 w-48">
          <NotesIndex currentPath={currentPath} />
        </div>
      )
    }

    <!-- 内容 -->
    <div class="flex-1 flex flex-col min-w-0">
      <main class="flex-1">
        <article class="max-w-3xl mx-auto">
          <div class="p-4">
            <slot />
          </div>
        </article>
      </main>
    </div>

    <!-- 桌面端大纲 -->
    {
      showToc && (
        <div class="hidden xl:block flex-shrink-0 w-48">
          <TableOfContents headings={headings} />
        </div>
      )
    }

    <!-- 移动端目录 -->
    {
      showSidebar && (
        <div class="lg:hidden">
          <div id="mobile-sidebar-overlay" class="fixed inset-0 z-40 hidden" />

          <div
            id="mobile-sidebar"
            class="fixed left-0 top-0 h-full w-60 z-50 px-4 backdrop-blur-lg bg-white/10 dark:bg-black/10 border-r border-gray-500/20 transform -translate-x-full transition-transform duration-300"
          >
            <NotesIndex currentPath={currentPath} />
          </div>

          <button
            id="mobile-sidebar-toggle"
            class="
          lg:hidden fixed bottom-6 left-6 z-30
          size-12 rounded-lg cursor-pointer
          flex items-center justify-center
          text-cyan-500 bg-cyan-500/10 backdrop-blur-sm 
          transition-colors duration-200
        "
            aria-label="打开/关闭目录"
          >
            <Icon name="mdi:file-tree" class="size-6" />
          </button>
        </div>
      )
    }

    <!-- 移动端大纲 -->
    {
      showToc && headings.length > 0 && (
        <div class="xl:hidden">
          <div id="mobile-toc-overlay" class="fixed inset-0 z-40 hidden" />

          <div
            id="mobile-toc"
            class="fixed right-0 top-0 h-full w-60 z-50 pl-4 backdrop-blur-lg bg-white/10 dark:bg-black/10 border-l border-gray-500/20 transform translate-x-full transition-transform duration-300"
          >
            <TableOfContents headings={headings} />
          </div>

          <button
            id="mobile-toc-toggle"
            class="
              xl:hidden fixed bottom-6 right-6 z-30
              size-12 rounded-lg cursor-pointer
              flex items-center justify-center
              text-cyan-500 bg-cyan-500/10 backdrop-blur-sm
              transition-colors duration-200
            "
            aria-label="打开/关闭大纲"
          >
            <Icon name="mdi:table-of-contents" class="size-6" />
          </button>
        </div>
      )
    }
  </div>

  <script>
    function initMobileSidebar() {
      const sidebar = document.getElementById("mobile-sidebar");
      const overlay = document.getElementById("mobile-sidebar-overlay");
      const toggle = document.getElementById("mobile-sidebar-toggle");

      if (!sidebar || !overlay || !toggle) return;

      function toggleSidebar() {
        if (!sidebar || !overlay) return;

        const isOpen = !sidebar.classList.contains("-translate-x-full");

        if (isOpen) {
          sidebar.classList.add("-translate-x-full");
          overlay.classList.add("hidden");
        } else {
          sidebar.classList.remove("-translate-x-full");
          overlay.classList.remove("hidden");
        }
      }

      // 绑定事件监听器
      toggle.addEventListener("click", toggleSidebar);
      overlay.addEventListener("click", toggleSidebar);
    }

    function initMobileToc() {
      const toc = document.getElementById("mobile-toc");
      const overlay = document.getElementById("mobile-toc-overlay");
      const toggle = document.getElementById("mobile-toc-toggle");

      if (!toc || !overlay || !toggle) return;

      function toggleToc() {
        if (!toc || !overlay) return;

        const isOpen = !toc.classList.contains("translate-x-full");

        if (isOpen) {
          toc.classList.add("translate-x-full");
          overlay.classList.add("hidden");
        } else {
          toc.classList.remove("translate-x-full");
          overlay.classList.remove("hidden");
        }
      }

      // 绑定事件监听器
      toggle.addEventListener("click", toggleToc);
      overlay.addEventListener("click", toggleToc);
    }

    // 页面加载完成后初始化
    document.addEventListener("DOMContentLoaded", function () {
      initMobileSidebar();
      initMobileToc();
    });
  </script>
</Layout>
